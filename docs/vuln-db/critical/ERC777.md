# ERC777 Hook-Based Reentrancy

```YAML
id: TBA
title: ERC777 Hook-Based Reentrancy
baseSeverity: C
category: reentrancy
language: solidity
blockchain: [ethereum, polygon, bsc, arbitrum, optimism]
impact: Reentrant execution via token hooks before state update
status: draft
complexity: medium
attack_vector: internal
mitigation_difficulty: medium
versions: [">=0.6.0", "<=0.8.25"]
cwe: CWE-841
swc: SWC-107
```

## üìù Description

- The ERC777 token standard introduces a powerful feature‚Äîtoken hooks (tokensToSend, tokensReceived)‚Äîwhich are automatically called during transfers. 
- However, these hooks open up implicit reentrancy vectors, as they can invoke arbitrary logic in the recipient contract before the original function completes.
- When a contract receives an ERC777 token, its tokensReceived() hook is triggered before the rest of the caller‚Äôs function completes, allowing the recipient to re-enter the caller and:

## üö® Vulnerable Code

```solidity

IERC777 public token;

mapping(address => uint256) public stakes;

function stake(uint256 amount) external {
    stakes[msg.sender] += amount;
    token.sendFrom(msg.sender, address(this), amount, ""); // ‚ùå triggers tokensReceived hook
}
```

## üß™ Exploit Scenario

Step-by-step exploit process:

1. A user calls stake() to deposit ERC777 tokens into a contract.
2. The sendFrom() call transfers tokens and triggers tokensReceived() on the contract.
3. The hook executes before stake() finishes.
4. The attacker‚Äôs tokensReceived() implementation calls stake() again recursively.
5. Internal state (e.g., stakes[msg.sender]) is incremented before the first call finishes, bypassing checks or doubling rewards.

**Assumptions:**

- The protocol interacts with ERC777 tokens that trigger tokensReceived() automatically.
- The recipient contract (attacker) implements a reentrant hook (e.g., tokensReceived() calls back into the sender).

## ‚úÖ Fixed Code

```solidity

bool private locked;

modifier nonReentrant() {
    require(!locked, "Reentrant call");
    locked = true;
    _;
    locked = false;
}

function stake(uint256 amount) external nonReentrant {
    token.sendFrom(msg.sender, address(this), amount, "");
    stakes[msg.sender] += amount;
}
```

## üß≠ Contextual Severity

```yaml

- context: "Default"
  severity: C
  reasoning: "Attacker can reenter logic and inflate state during `tokensReceived()` callback."
- context: "Vault protected by ReentrancyGuard or using ERC20"
  severity: L
  reasoning: "Attack vector neutralized through state-first logic or token standard."
- context: "Protocol accepts unverified ERC777 tokens without checks"
  severity: C
  reasoning: "High likelihood of attack via fake or malicious tokens."
```

## üõ°Ô∏è Prevention

### Primary Defenses

- Always apply nonReentrant modifiers to functions that interact with ERC777 tokens.
- Move all state-changing logic before send() or transfer() operations.
- Consider rejecting ERC777 tokens entirely if not required.

### Additional Safeguards

- Whitelist trusted ERC777 tokens only.
- Require msg.sender to be an EOA (not a contract) where possible.
- Audit the full call graph including tokensReceived and tokensToSend.

### Detection Methods

- Static analysis for ERC777 transfers within vulnerable functions.
- Manual inspection for unexpected reentrancy via hooks.
- Tools: Slither (reentrancy-eth), MythX, Echidna recursive fuzzing

## üï∞Ô∏è Historical Exploits

- **Name:** ERC777 Hook-Based Reentrancy  
- **Date:** 2020-02  
- **Loss:** $0  
- **Post-mortem:** [Link to post-mortem](https://forum.openzeppelin.com/t/erc777-tokens-and-reentrancy-attacks/1620)  

## üìö Further Reading

- [SWC-107: Reentrancy](https://swcregistry.io/docs/SWC-107) 
- [CWE-841: Improper Enforcement of Behavioral Workflow](https://cwe.mitre.org/data/definitions/841.html) 
- [ERC777 Spec ‚Äì EIP-777](https://eips.ethereum.org/EIPS/eip-777) 
  
---

## ‚úÖ Vulnerability Report

```markdown
id: TBA
title: ERC777 Hook-Based Reentrancy
severity: C
score:
impact: 5  
exploitability: 4   
reachability: 4   
complexity: 3  
detectability: 4   
finalScore: 4.4
```

---

## üìÑ Justifications & Analysis

- **Impact**: Can lead to full fund drain or duplicated state due to early reentry.
- **Exploitability**: Anyone can deploy a hook-enabled contract and trigger it via ERC777 transfer.
- **Reachability**: Applies to all contracts that accept ERC777 and perform external token logic.
- **Complexity**: Moderate attacker effort; hooks and modifiers must be well understood.
- **Detectability**: High with correct tooling; most scanners catch unsafe ERC777 flows.
